# ユーザーフロー設計

本ドキュメントでは、教師・生徒・未ログインユーザーの主要な操作フローを整理する。既存の要件（要件定義書、データモデル、アーキテクチャ）と整合するように記載する。

## 1. ロール別概要

- **運用者/教師**: 唯一の教師として全コンテンツの作成/公開、CSV一括登録、学習状況確認を行う。必要に応じて他者を生徒→教師に昇格させる。
- **生徒（ログイン）**: 割り当て科目/授業/コンテンツで学習し、ログインした状態で視聴ログや小テスト結果を残す。
- **未ログイン閲覧者**: 公開コンテンツを閲覧できるが、学習ログ・テスト受験は不可。授業終了後もコンテンツを参照可能。

## 2. 教師フロー

### 2.1 ログイン
1. 教師が `/login` でGoogle OAuthを利用してログイン。
2. `users` コレクションに登録済みで `role='teacher'` の場合のみダッシュボードへ遷移。

### 2.2 コンテンツ管理
1. ダッシュボードの「科目/単元/授業」管理画面へ。
2. 新規作成フォームで名称・年度設定・公開状態を入力し、Firestoreへ保存。
3. 授業内で動画/小テスト/リンクのコンテンツを追加し、`publishStatus` を切り替えて公開タイミングを制御。
4. 既存コンテンツの編集/削除も同画面で行う。

### 2.3 CSV一括登録
1. 管理画面でテンプレートCSVをダウンロード。
2. 生徒/科目/単元/授業/コンテンツ情報をCSVに入力。
3. CSVをアップロード → Storageに保存 → Cloud Functionが処理。
4. 処理結果（成功/エラー件数）を画面に表示し、必要に応じてエラーログをCSVでダウンロード。

### 2.4 学習状況確認
1. 学習進捗ページで `progress_snapshots` やリアルタイムクエリを参照。
2. 科目/単元/授業単位でフィルタ、個別生徒の動画視聴時間や小テスト正答率を確認（教師アカウントで記録されたログは自動的に除外される）。
3. 必要に応じてエクスポート（CSV/Googleスプレッドシート）機能を利用。

### 2.5 ユーザー管理
1. 生徒のメールアドレスを管理画面から登録（`users` に反映、Firebase Authへ招待する場合は手動）。
2. 他の教師を招待する場合は、一旦生徒アカウントとして登録後、Firebase Consoleで手動で `role` を変更。
3. 年度切り替え時は `academicYear` を更新し、不要なユーザーは手動で無効化（Firebase Authから削除）する。

### 2.6 生徒画面の再現利用
1. 教師アカウントも生徒コンテンツにアクセス可能とし、授業内コンテンツ・小テストを生徒と同じUIで閲覧できる。
2. 生徒向けダッシュボード（進捗一覧、コンテンツ一覧）にもアクセスできるが、学習ログは教師のユーザーIDで記録され、`progress_snapshots` 集計からは自動的に除外される。
3. 生徒への操作説明時は教師アカウントで画面確認し、必要に応じてスクリーンショット等を共有する。

## 3. 生徒フロー（ログイン済み）

### 3.1 ログイン
1. `/login` からGoogle OAuthでログイン（登録済みメールのみ許可）。
2. 初回ログイン時に `users` ドキュメントが自動作成/確認され、プロフィール情報を確認。

### 3.2 コンテンツ閲覧
1. ダッシュボードで自分の科目/単元/授業の一覧を閲覧。
2. 授業詳細ページで動画/小テスト/リンクを表示。公開中のコンテンツのみ表示。

### 3.3 動画視聴（ログ記録あり）
1. YouTube埋め込みプレイヤーで動画を再生。
2. 2分以上再生（または一定割合）で視聴済みとして `video_progress` に記録。
3. ダッシュボードの進捗バーや授業ページに反映される。

### 3.4 小テスト受験
1. 授業内の小テストコンテンツを開く。
2. `questionsPerAttempt`（デフォルト5問）分をランダム抽選した問題が出題。
3. 解答送信後、正誤結果が表示され `test_attempts` に記録。
4. 必要なら再受験し、履歴が残る。

### 3.5 自身の学習履歴閲覧
1. ダッシュボードで完了済み/未完了コンテンツ、小テスト正答率、最新の学習日時を確認。
2. 再学習したいコンテンツを開き直せる（ログは再度上書き/追加）。

## 4. 未ログインユーザーフロー

### 4.1 コンテンツ閲覧
1. トップページや科目一覧ページで公開授業を表示。
2. ログイン無しで授業詳細・動画・リンクを閲覧可能。
3. 小テストを起動すると、ログインを促すダイアログを表示し、ログなしでの受験は不可。

### 4.2 ログイン誘導
1. 授業画面で「学習ログを残す」ボタンを押すと、ログイン画面へ遷移。
2. ログイン後は元の授業にリダイレクトし、視聴ログやテスト結果を記録できる。

## 5. 年度末の運用フロー（教師）

1. 学習期間終了後、`document/design/log_export_and_cleanup.md` に従って `video_progress` / `test_attempts` をエクスポート。
2. 手動で対象年度のログを削除し、必要に応じて `progress_snapshots` の再集計を実行。
3. 次年度用に `app_configs.currentAcademicYear` を更新し、新しいCSVテンプレートを準備。

## 6. 例外/エラー対応

- 認証エラー: ホワイトリストに無いメールでログインした場合、専用ページで「アクセス権限がありません」と表示。
- CSVエラー: フォーマット不備時は行番号とエラー内容を表示し、修正したCSVを再アップロード。
- 動画再生エラー: YouTube埋め込み不可の場合、URLリンクで代替表示しログ記録は行わない。
- Cloud Functions失敗: Functionsログを確認し、再実行または手動操作でリカバリ。運用ノートに記録。

## 7. 今後の拡張アイデア

- 教師が複数名になった場合の共同編集フロー。
- 生徒間の質問やコメント機能の追加時に想定されるフロー。
- プッシュ通知（メール）によるリマインダー送信フロー。
